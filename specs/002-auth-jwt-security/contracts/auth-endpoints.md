# Auth Endpoint Contracts

**Feature**: `002-auth-jwt-security`

## Better Auth Endpoints (managed by library, frontend)

These endpoints are auto-generated by Better Auth and served by Next.js.
They are NOT implemented manually.

| Method | Path | Description |
|--------|------|-------------|
| POST | /api/auth/sign-up/email | Create account with email + password |
| POST | /api/auth/sign-in/email | Sign in with email + password |
| POST | /api/auth/sign-out | Sign out, clear session |
| GET | /api/auth/get-session | Get current session + JWT header |
| GET | /api/auth/token | Get JWT token directly |
| GET | /api/auth/jwks | Public keys for JWT verification |

## Backend API Changes (FastAPI)

### Before (feature 001)

```
POST   /api/users/{user_id}/todos
GET    /api/users/{user_id}/todos
GET    /api/users/{user_id}/todos/{task_id}
PATCH  /api/users/{user_id}/todos/{task_id}
DELETE /api/users/{user_id}/todos/{task_id}
```

### After (feature 002)

```
POST   /api/todos              Authorization: Bearer <jwt>
GET    /api/todos              Authorization: Bearer <jwt>
GET    /api/todos/{task_id}    Authorization: Bearer <jwt>
PATCH  /api/todos/{task_id}    Authorization: Bearer <jwt>
DELETE /api/todos/{task_id}    Authorization: Bearer <jwt>
```

**Change**: `user_id` removed from path. User identity extracted from JWT
`sub` claim. All endpoints require `Authorization: Bearer <token>` header.

### Error Responses

| Status | Condition | Body |
|--------|-----------|------|
| 401 | Missing Authorization header | `{"detail": "Not authenticated"}` |
| 401 | Invalid/expired/tampered token | `{"detail": "Invalid or expired token"}` |
| 404 | Task not found or not owned | `{"detail": "Task not found"}` |
| 422 | Validation error | `{"detail": [...]}` |

### JWT Verification Dependency

Every protected endpoint receives the authenticated user via FastAPI
`Depends(get_current_user)`:

```python
async def get_current_user(
    authorization: str = Header(...)
) -> dict:
    # Extract Bearer token
    # Verify with JWKS public key
    # Return {"user_id": sub, "email": email}
```
